# 要件定義書

## 概要

会話データをアップロードしたユーザーに対して USDC を報酬として配布するスマートコントラクトシステムを実装します。

このシステムでは、管理者がユーザーのポイントを管理し、ユーザーがポイントを USDC に交換できる仕組みを提供します。

Base Sepolia ネットワーク上で動作し、OpenZeppelin ライブラリを活用してセキュアな実装を行います。

## 要件

### 要件 1

**ユーザーストーリー:** 管理者として、ユーザーのポイントを管理したい。

これにより、会話データをアップロードしたユーザーに報酬を与えることができる。

#### 受入基準

1. 管理者が addPoints 関数を呼び出した時、システムは指定されたユーザーのポイント残高を増加させる
2. 管理者が transferPoints 関数を呼び出した時、システムは指定されたユーザーのポイント量をユーザーに送金する。付与した分は残高から引く
3. transferPoints の金額がユーザーの現在の残高を超える場合、システムはトランザクションを取り消す
4. ポイントが追加または送金された時、システムはユーザーアドレスとポイント変更量を含むイベントを発行する

### 要件 2

**ユーザーストーリー:** 管理者として、ポイントと USDC の交換レートを設定したい。

これにより、報酬の経済性をコントロールできる。

#### 受入基準

1. 管理者が setExchangeRate 関数を呼び出した時、システムはポイントから USDC への変換レートを更新する
2. 交換レートが設定された時、システムは新しいレートを含むイベントを発行する
3. 管理者以外が交換レートを設定しようとした場合、システムはトランザクションを取り消す
4. 交換レートが 0 の時、システムは USDC の請求を防ぐ

### 要件 3

**ユーザーストーリー:** ユーザーとして、自分のポイントを USDC に交換したい。

これにより、会話データアップロードの報酬を受け取ることができる。

#### 受入基準

1. ユーザーが有効なポイント量で claimUSDC 関数を呼び出した時、システムは相当する USDC をユーザーに転送する
2. ユーザーが USDC を請求した時、システムは対応するポイントをユーザーの残高から差し引く
3. ユーザーのポイントが不足している場合、システムはトランザクションを取り消す
4. コントラクトの USDC 残高が不足している場合、システムはトランザクションを取り消す
5. USDC が請求された時、システムはユーザーアドレス、使用されたポイント、USDC 金額を含むイベントを発行する

### 要件 4

**ユーザーストーリー:** ユーザーとして、自分のポイント残高を確認したい。

これにより、どれだけの USDC を請求できるかを知ることができる。

#### 受入基準

1. ユーザーが getPointBalance 関数を呼び出した時、システムは現在のポイント残高を返す
2. ユーザーがポイントを指定して calculateUSDCAmount 関数を呼び出した時、システムは相当する USDC 金額を返す
3. 交換レートが設定されていない時、calculateUSDCAmount は 0 を返す

### 要件 5

**ユーザーストーリー:** 管理者として、コントラクト内の USDC 供給を管理したい。

これにより、ユーザーが報酬を請求できるようになる。

#### 受入基準

1. 管理者がコントラクトに USDC を入金した時、システムはコントラクトの USDC 残高を増加させる
2. 管理者がコントラクトから USDC を出金した時、システムはコントラクトの USDC 残高を減少させる
3. 管理者以外が USDC を出金しようとした場合、システムはトランザクションを取り消す
4. USDC が入金または出金された時、システムは適切なイベントを発行する

### 要件 6

**ユーザーストーリー:** 管理者として、適切なアクセス制御を持ちたい。

これにより、認可されたユーザーのみが管理機能を実行できる。

#### 受入基準

1. コントラクトがデプロイされた時、デプロイヤーが初期管理者として設定される
2. 管理者が所有権を移転した時、新しい管理者がすべての管理権限を持つ
3. 管理者以外が管理機能を呼び出そうとした場合、システムは適切なエラーメッセージでトランザクションを取り消す
4. 所有権が移転された時、システムは所有権移転イベントを発行する

### 要件 7

**ユーザーストーリー:** 開発者として、コントラクトがエッジケースを適切に処理してほしい。

これにより、システムが堅牢でセキュアになる。

#### 受入基準

1. 任意の関数がゼロアドレスを受け取った時、システムはトランザクションを取り消す
2. ポイントや USDC 金額がゼロの時、システムは適切に処理するか、必要に応じて取り消す
3. コントラクトが一時停止された時、ユーザー機能は無効になるが管理機能は利用可能のままとする
4. リエントランシー攻撃が試行された場合、システムは適切なガードを使用してそれを防ぐ
